# GR Atom: EternalRomance
# Schema: atom_schema.yaml v5.1
# Status: enriched

# ==== Section 1: Identity ====
identity:
  id: "VUL-MEMORY-ETERROMA-001"
  name: "EternalRomance"
  normalized_name: "eternal_romance"
  aliases:
    - "CVE-2017-0145"
    - "SMBv1 Transaction Type Confusion"
    - "Shadow Brokers SMB Write Exploit"

# ==== Section 2: Classification ====
classification:
  is_infrastructure: false
  type: "vulnerability"
  abstraction_level: 1
  atom_tags:
    - EXEC
    - INITIAL
    - LATERAL
    - OVERFLOW
    - WINDOWS
    - NETWORK
    - SMB

# ==== Section 4: Scope (non-INFRA only) ====
scope:
  target_layers: ["L4", "L5"]
  target_zones: ["Z1", "Z2", "Z3"]
  target_components:
    - "Windows SMBv1 server (srv.sys)"
    - "Windows XP through Windows Server 2016"
    - "Microsoft Server Message Block 1.0 (port 445)"

# ==== Section 5: Definition ====
definition:
  what: >-
    EternalRomance is a remote code execution exploit (CVSS 8.1, CVE-2017-0145) targeting
    a type confusion vulnerability in Microsoft's SMBv1 protocol implementation. Part of
    the NSA's Equation Group toolkit leaked by the Shadow Brokers in April 2017,
    EternalRomance exploits a flaw in how SMBv1 handles transaction type structures to
    achieve arbitrary read/write access to kernel memory. Unlike EternalBlue's buffer
    overflow, EternalRomance uses a type confusion between SMB Transaction and
    Write AndX requests to corrupt kernel memory structures. It was patched in MS17-010
    alongside EternalBlue and other SMBv1 vulnerabilities. EternalRomance was used by
    the Bad Rabbit ransomware and by APT groups for lateral movement.
  why: >-
    EternalRomance provides an alternative exploitation path to EternalBlue for
    compromising SMBv1 targets, using a different vulnerability class (type confusion vs.
    buffer overflow). This makes it valuable when EternalBlue-specific mitigations are in
    place. It was incorporated into the NotPetya and Bad Rabbit malware campaigns,
    demonstrating how multiple SMBv1 exploit variants can be combined for maximum
    coverage. The exploit also highlighted the depth of the NSA's SMBv1 exploit arsenal,
    with multiple independent exploitation paths for the same protocol.
  how: >-
    EternalRomance exploits a type confusion between SMB_COM_TRANSACTION and
    SMB_COM_WRITE_ANDX request handling in srv.sys. The exploit sends an SMB Write AndX
    request that the server incorrectly processes as a Transaction request due to
    improper type validation. This confusion allows the attacker to write arbitrary data
    to kernel memory at controlled offsets. By targeting specific kernel structures, the
    attacker achieves arbitrary read/write primitives and ultimately gains kernel-mode
    code execution. The exploit provides a different reliability profile than EternalBlue,
    working on some Windows versions where EternalBlue is less reliable.
  core_concepts:
    - key: "SMBv1 Type Confusion"
      value: "Type confusion between Transaction and Write AndX requests enables kernel memory read/write primitives"
    - key: "Alternative to EternalBlue"
      value: "Different exploit path for SMBv1 targets, used when EternalBlue mitigations are present or exploitation unreliable"
    - key: "Ransomware Propagation"
      value: "Used in Bad Rabbit ransomware and NotPetya campaigns for network propagation via SMBv1"

# ==== Section 6: Relations ====
relations:
  - type: "instance_of"
    target: "VUL-MEMORY-MEMORY-001"
    description: "EternalRomance is a type confusion memory corruption in Windows SMBv1 kernel driver"
  - type: "alternative_to"
    target: "VUL-MEMORY-ETERBLUE-001"
    description: "Alternative SMBv1 exploitation path using type confusion instead of buffer overflow"
  - type: "enables"
    target: "VUL-MEMORY-ETERSYNE-001"
    description: "Both are Eternal-family SMBv1 exploits from the Shadow Brokers NSA tool leak"

# ==== Section 7: Security Profile ====
security_profile:
  mitre_mapping:
    technique_id: "T1210"
    tactic:
      - "Lateral Movement"
      - "Initial Access"

# ==== Section 8: Metadata ====
metadata:
  created: "2026-02-06"
  updated: "2026-02-11"
  version: "1.0"
  confidence: "high"
  trust_source: "authoritative"
  sources:
    - "Microsoft Security Bulletin MS17-010"
    - "NVD Entry CVE-2017-0145 - CVSS 8.1"
    - "Shadow Brokers Leak - EternalRomance exploit"
    - "MITRE ATT&CK T1210 - Exploitation of Remote Services"
  search_keywords:
    - "EternalRomance"
    - "CVE-2017-0145"
    - "SMBv1"
    - "type confusion"
    - "Shadow Brokers"
    - "NSA"
    - "Bad Rabbit"
    - "MS17-010"
    - "lateral movement"
  embedding_text: >-
    EternalRomance is a remote code execution exploit targeting CVE-2017-0145 in Windows
    SMBv1, developed by the NSA and leaked by Shadow Brokers. It exploits a type confusion
    between SMB Transaction and Write AndX requests in srv.sys to achieve kernel memory
    read/write primitives and code execution. An alternative to EternalBlue using a
    different vulnerability class, it was used in Bad Rabbit ransomware and NotPetya
    campaigns. Part of the MS17-010 patch cycle, it demonstrates the depth of NSA's
    SMBv1 exploit arsenal with multiple independent exploitation paths.
