-- ============================================================================
-- GR Framework v2.0 - Vulnerability Extension Schema
-- Purpose: CVE/CWE/OWASP/Named Vulnerability 확장 + GR 좌표 매핑
-- Extends: 01_schema.sql (기존 CVE, MITRE 테이블)
-- Database: PostgreSQL 15+
-- Version: 1.0 (2025-12-01)
-- ============================================================================

-- ============================================================================
-- 1. CWE (Common Weakness Enumeration) 테이블
-- ============================================================================

-- 1.1 CWE 카테고리 (계층 구조 상위)
CREATE TABLE cwe_categories (
    id VARCHAR(20) PRIMARY KEY,               -- CWE-1000, CWE-699, CWE-1003 등
    name VARCHAR(255) NOT NULL,               -- "Software Development"
    name_ko VARCHAR(255),                     -- "소프트웨어 개발"
    description TEXT,
    category_type VARCHAR(50),                -- "View", "Category", "Pillar"
    parent_id VARCHAR(20) REFERENCES cwe_categories(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 1.2 CWE (개별 약점 유형)
CREATE TABLE cwe (
    id VARCHAR(20) PRIMARY KEY,               -- CWE-79, CWE-89, CWE-787 등
    name VARCHAR(255) NOT NULL,               -- "Improper Neutralization of Input During Web Page Generation"
    name_ko VARCHAR(255),                     -- "웹 페이지 생성 시 입력값 부적절한 무력화"
    name_short VARCHAR(100),                  -- "XSS" (짧은 이름)
    description TEXT,
    description_ko TEXT,

    -- 분류
    category_id VARCHAR(20) REFERENCES cwe_categories(id),
    abstraction VARCHAR(50),                  -- "Pillar", "Class", "Base", "Variant", "Compound"
    structure VARCHAR(50),                    -- "Simple", "Composite", "Chain"

    -- 위험도 및 영향
    likelihood_of_exploit VARCHAR(20),        -- "High", "Medium", "Low"
    common_consequences JSONB,                -- [{"scope": "Confidentiality", "impact": "Read Data"}]

    -- 탐지 및 완화
    detection_methods JSONB,                  -- [{"method": "Static Analysis", "effectiveness": "High"}]
    potential_mitigations JSONB,              -- [{"phase": "Implementation", "description": "..."}]

    -- 관련 정보
    related_cwes JSONB,                       -- [{"cwe_id": "CWE-20", "type": "ChildOf"}]
    applicable_platforms JSONB,               -- {"language": ["PHP", "Java"], "technology": ["Web Server"]}

    -- 외부 매핑
    capec_ids TEXT[],                         -- CAPEC 공격 패턴 ID 배열
    owasp_ids TEXT[],                         -- OWASP Top 10 ID 배열 (A01, A03 등)

    -- URL
    mitre_url TEXT,                           -- https://cwe.mitre.org/data/definitions/79.html

    -- 메타데이터
    status VARCHAR(50) DEFAULT 'active',      -- "active", "deprecated", "draft"
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_cwe_category ON cwe(category_id);
CREATE INDEX idx_cwe_abstraction ON cwe(abstraction);
CREATE INDEX idx_cwe_name_search ON cwe USING gin(to_tsvector('english', name || ' ' || COALESCE(name_short, '')));

-- 1.3 CWE-GR 좌표 매핑 (어떤 Layer/Zone/Tag에서 발생 가능한지)
CREATE TABLE cwe_gr_mapping (
    id SERIAL PRIMARY KEY,
    cwe_id VARCHAR(20) REFERENCES cwe(id) ON DELETE CASCADE,

    -- GR 좌표 (Layer/Zone/Tag)
    layer_id VARCHAR(20) REFERENCES layers(id),
    zone_id VARCHAR(20) REFERENCES zones(id),
    tag_id VARCHAR(20) REFERENCES tags(id),

    -- 매핑 컨텍스트
    context_description TEXT,                 -- "웹 애플리케이션의 입력 처리 시"
    attack_scenario TEXT,                     -- 공격 시나리오 설명

    -- 탐지/완화 태그
    detection_tags TEXT[],                    -- {M6.1, S1.2} - 탐지 가능한 Function Tag
    mitigation_tags TEXT[],                   -- {S2.1, A3.2} - 완화 가능한 Function Tag

    -- 신뢰도
    confidence DECIMAL(3,2) DEFAULT 0.80,     -- 매핑 신뢰도
    mapping_source VARCHAR(100),              -- "manual", "ai_classifier", "mitre"

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(cwe_id, layer_id, zone_id, tag_id)
);

CREATE INDEX idx_cwe_gr_cwe ON cwe_gr_mapping(cwe_id);
CREATE INDEX idx_cwe_gr_layer ON cwe_gr_mapping(layer_id);
CREATE INDEX idx_cwe_gr_zone ON cwe_gr_mapping(zone_id);
CREATE INDEX idx_cwe_gr_tag ON cwe_gr_mapping(tag_id);

-- ============================================================================
-- 2. OWASP Top 10 테이블
-- ============================================================================

-- 2.1 OWASP Top 10 버전 (연도별)
CREATE TABLE owasp_versions (
    id VARCHAR(20) PRIMARY KEY,               -- "2021", "2017", "2013"
    name VARCHAR(100) NOT NULL,               -- "OWASP Top 10 2021"
    release_date DATE,
    is_current BOOLEAN DEFAULT FALSE,
    url TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2.2 OWASP Top 10 항목
CREATE TABLE owasp_top10 (
    id VARCHAR(20) PRIMARY KEY,               -- "A01:2021", "A03:2021"
    owasp_version_id VARCHAR(20) REFERENCES owasp_versions(id),

    -- 기본 정보
    rank INT NOT NULL,                        -- 1, 2, 3, ... 10
    name VARCHAR(255) NOT NULL,               -- "Broken Access Control"
    name_ko VARCHAR(255),                     -- "취약한 접근 제어"
    description TEXT,
    description_ko TEXT,

    -- 통계 (OWASP에서 제공)
    max_incidence_rate DECIMAL(5,2),          -- 최대 발생률 (%)
    avg_incidence_rate DECIMAL(5,2),          -- 평균 발생률 (%)
    max_coverage DECIMAL(5,2),                -- 최대 커버리지 (%)
    avg_coverage DECIMAL(5,2),                -- 평균 커버리지 (%)
    avg_weighted_exploit DECIMAL(3,2),        -- 평균 가중 악용 가능성
    avg_weighted_impact DECIMAL(3,2),         -- 평균 가중 영향도
    total_occurrences INT,                    -- 총 발생 건수
    total_cves INT,                           -- 관련 CVE 총 수

    -- 관련 CWE
    mapped_cwes TEXT[],                       -- {CWE-79, CWE-89, CWE-352}

    -- 예방/대응
    how_to_prevent TEXT,
    example_attack_scenarios TEXT,

    -- URL
    owasp_url TEXT,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_owasp_version ON owasp_top10(owasp_version_id);
CREATE INDEX idx_owasp_rank ON owasp_top10(rank);

-- 2.3 OWASP-GR 좌표 매핑
CREATE TABLE owasp_gr_mapping (
    id SERIAL PRIMARY KEY,
    owasp_id VARCHAR(20) REFERENCES owasp_top10(id) ON DELETE CASCADE,

    -- GR 좌표
    layer_id VARCHAR(20) REFERENCES layers(id),
    zone_id VARCHAR(20) REFERENCES zones(id),
    tag_id VARCHAR(20) REFERENCES tags(id),

    -- 매핑 컨텍스트
    risk_level VARCHAR(20),                   -- "Critical", "High", "Medium"
    typical_occurrence TEXT,                  -- 발생 위치/상황 설명

    -- 탐지/완화 태그
    detection_tags TEXT[],
    mitigation_tags TEXT[],

    confidence DECIMAL(3,2) DEFAULT 0.85,

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(owasp_id, layer_id, zone_id, tag_id)
);

CREATE INDEX idx_owasp_gr_owasp ON owasp_gr_mapping(owasp_id);
CREATE INDEX idx_owasp_gr_layer ON owasp_gr_mapping(layer_id);
CREATE INDEX idx_owasp_gr_zone ON owasp_gr_mapping(zone_id);

-- ============================================================================
-- 3. Named Vulnerabilities (유명 취약점)
-- ============================================================================

-- 3.1 Named Vulnerabilities (Log4Shell, Heartbleed 등)
CREATE TABLE named_vulnerabilities (
    id SERIAL PRIMARY KEY,

    -- 식별 정보
    name VARCHAR(100) NOT NULL UNIQUE,        -- "Log4Shell", "Heartbleed", "Shellshock"
    name_ko VARCHAR(100),                     -- "로그4쉘"
    aliases TEXT[],                           -- {"Log4j RCE", "CVE-2021-44228 vulnerability"}

    -- 관련 CVE (1:N)
    primary_cve_id VARCHAR(20),               -- 대표 CVE (CVE-2021-44228)
    related_cves TEXT[],                      -- 관련 CVE 배열 {CVE-2021-45046, CVE-2021-45105}

    -- 기본 정보
    description TEXT,
    description_ko TEXT,

    -- 심각도
    severity VARCHAR(20),                     -- "Critical", "High", "Medium", "Low"
    cvss_score DECIMAL(3,1),                  -- 대표 CVSS 점수

    -- 영향
    affected_products JSONB,                  -- [{"vendor": "Apache", "product": "Log4j", "versions": "2.0-2.14.1"}]
    impact_description TEXT,                  -- 영향 설명
    exploitation_in_wild BOOLEAN DEFAULT FALSE, -- 실제 악용 사례 여부
    exploitation_date DATE,                   -- 최초 악용 발견일

    -- 기술 정보
    vulnerability_type VARCHAR(100),          -- "Remote Code Execution", "Information Disclosure"
    attack_vector VARCHAR(50),                -- "Network", "Local"
    cwe_id VARCHAR(20) REFERENCES cwe(id),

    -- 타임라인
    disclosure_date DATE,                     -- 공개일
    patch_date DATE,                          -- 패치 배포일

    -- 대응 정보
    remediation_summary TEXT,                 -- 간단한 대응 방법
    workarounds TEXT,                         -- 임시 조치
    patch_links JSONB,                        -- [{"vendor": "Apache", "url": "..."}]

    -- 외부 리소스
    references JSONB,                         -- 참조 링크들
    logo_url TEXT,                            -- 취약점 로고 (Heartbleed 하트 등)

    -- 메타데이터
    is_notable BOOLEAN DEFAULT TRUE,          -- 주목할 만한 취약점 여부
    media_attention_score INT,                -- 미디어 관심도 (1-10)

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_named_vuln_name ON named_vulnerabilities(name);
CREATE INDEX idx_named_vuln_cve ON named_vulnerabilities(primary_cve_id);
CREATE INDEX idx_named_vuln_severity ON named_vulnerabilities(severity);
CREATE INDEX idx_named_vuln_date ON named_vulnerabilities(disclosure_date DESC);

-- 3.2 Named Vulnerability - GR 좌표 매핑
CREATE TABLE named_vulnerability_gr_mapping (
    id SERIAL PRIMARY KEY,
    named_vulnerability_id INT REFERENCES named_vulnerabilities(id) ON DELETE CASCADE,

    -- GR 좌표
    layer_id VARCHAR(20) REFERENCES layers(id),
    zone_id VARCHAR(20) REFERENCES zones(id),
    tag_id VARCHAR(20) REFERENCES tags(id),

    -- 영향도
    impact_level VARCHAR(20),                 -- "Critical", "High", "Medium", "Low"
    affected_components TEXT,                 -- 영향받는 구성요소 설명

    -- 탐지/완화
    detection_tags TEXT[],
    mitigation_tags TEXT[],

    confidence DECIMAL(3,2) DEFAULT 0.90,

    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(named_vulnerability_id, layer_id, zone_id, tag_id)
);

CREATE INDEX idx_named_gr_vuln ON named_vulnerability_gr_mapping(named_vulnerability_id);
CREATE INDEX idx_named_gr_layer ON named_vulnerability_gr_mapping(layer_id);

-- ============================================================================
-- 4. CVE 테이블 확장 (기존 cve 테이블에 FK 추가)
-- ============================================================================

-- 4.1 기존 cve 테이블에 CWE FK 추가 (ALTER)
-- 주의: 이미 cwe_id VARCHAR(20)이 있으므로 FK만 추가
ALTER TABLE cve
ADD CONSTRAINT fk_cve_cwe
FOREIGN KEY (cwe_id) REFERENCES cwe(id) ON DELETE SET NULL;

-- 4.2 CVE-GR 좌표 매핑 (CVE가 영향을 미치는 Layer/Zone/Tag)
CREATE TABLE cve_gr_mapping (
    id SERIAL PRIMARY KEY,
    cve_id VARCHAR(20) REFERENCES cve(cve_id) ON DELETE CASCADE,

    -- GR 좌표
    layer_id VARCHAR(20) REFERENCES layers(id),
    zone_id VARCHAR(20) REFERENCES zones(id),
    tag_id VARCHAR(20) REFERENCES tags(id),

    -- 매핑 컨텍스트
    affected_context TEXT,                    -- 영향받는 상황/컨텍스트
    risk_level VARCHAR(20),                   -- 해당 좌표에서의 위험도

    -- 탐지/완화 태그
    detection_tags TEXT[],
    mitigation_tags TEXT[],

    -- 신뢰도 및 출처
    confidence DECIMAL(3,2) DEFAULT 0.75,
    mapping_source VARCHAR(100),              -- "ai_classifier", "manual", "nvd_derived"

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(cve_id, layer_id, zone_id, tag_id)
);

CREATE INDEX idx_cve_gr_cve ON cve_gr_mapping(cve_id);
CREATE INDEX idx_cve_gr_layer ON cve_gr_mapping(layer_id);
CREATE INDEX idx_cve_gr_zone ON cve_gr_mapping(zone_id);
CREATE INDEX idx_cve_gr_tag ON cve_gr_mapping(tag_id);

-- 4.3 CVE-Named Vulnerability 매핑
CREATE TABLE cve_named_vulnerability (
    id SERIAL PRIMARY KEY,
    cve_id VARCHAR(20) REFERENCES cve(cve_id) ON DELETE CASCADE,
    named_vulnerability_id INT REFERENCES named_vulnerabilities(id) ON DELETE CASCADE,
    is_primary BOOLEAN DEFAULT FALSE,         -- 대표 CVE 여부
    created_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(cve_id, named_vulnerability_id)
);

CREATE INDEX idx_cve_named_cve ON cve_named_vulnerability(cve_id);
CREATE INDEX idx_cve_named_vuln ON cve_named_vulnerability(named_vulnerability_id);

-- ============================================================================
-- 5. 분류 엔진용 Staging/Log 테이블
-- ============================================================================

-- 5.1 취약점 분류 로그 (AI 분류 결과 추적)
CREATE TABLE vulnerability_classification_log (
    id SERIAL PRIMARY KEY,

    -- 분류 대상
    source_type VARCHAR(50) NOT NULL,         -- "cve", "cwe", "owasp", "named"
    source_id VARCHAR(50) NOT NULL,           -- CVE-2021-44228, CWE-79 등

    -- 분류 결과
    assigned_layer VARCHAR(20),
    assigned_zone VARCHAR(20),
    assigned_tags TEXT[],

    -- AI 분류 메타데이터
    classifier_version VARCHAR(20),           -- 분류 엔진 버전
    confidence_score DECIMAL(3,2),            -- 전체 신뢰도
    layer_confidence DECIMAL(3,2),
    zone_confidence DECIMAL(3,2),
    tag_confidences JSONB,                    -- {"S1.1": 0.92, "N2.3": 0.78}

    -- 입력 데이터
    input_text TEXT,                          -- 분류에 사용된 텍스트
    input_tokens INT,                         -- 사용된 토큰 수

    -- 처리 정보
    processing_time_ms INT,                   -- 처리 시간 (밀리초)
    model_used VARCHAR(100),                  -- 사용된 AI 모델

    -- 검증
    human_reviewed BOOLEAN DEFAULT FALSE,
    reviewer VARCHAR(100),
    reviewed_at TIMESTAMP,
    review_notes TEXT,

    -- 수정 (검증 후 변경된 경우)
    corrected_layer VARCHAR(20),
    corrected_zone VARCHAR(20),
    corrected_tags TEXT[],

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_vuln_class_log_source ON vulnerability_classification_log(source_type, source_id);
CREATE INDEX idx_vuln_class_log_date ON vulnerability_classification_log(created_at DESC);
CREATE INDEX idx_vuln_class_log_reviewed ON vulnerability_classification_log(human_reviewed);

-- 5.2 취약점 Staging 테이블 (크롤링/수집된 데이터)
CREATE TABLE staging_vulnerability (
    id SERIAL PRIMARY KEY,

    -- 원본 데이터
    raw_data JSONB NOT NULL,                  -- 크롤링된 원본 JSON
    data_source VARCHAR(100) NOT NULL,        -- "nvd", "github_advisory", "exploit_db"
    source_url TEXT,

    -- 파싱 결과
    parsed_type VARCHAR(50),                  -- "cve", "cwe", "exploit"
    parsed_id VARCHAR(50),                    -- CVE-2024-xxxxx
    parsed_severity VARCHAR(20),
    parsed_description TEXT,

    -- 처리 상태
    status VARCHAR(50) DEFAULT 'pending',     -- "pending", "classified", "approved", "rejected", "imported"
    classification_id INT REFERENCES vulnerability_classification_log(id),

    -- 검토
    reviewed_by VARCHAR(100),
    reviewed_at TIMESTAMP,
    rejection_reason TEXT,

    -- 가져오기
    imported_to_production BOOLEAN DEFAULT FALSE,
    imported_at TIMESTAMP,
    target_table VARCHAR(50),                 -- "cve", "cwe", "named_vulnerabilities"

    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_staging_vuln_status ON staging_vulnerability(status);
CREATE INDEX idx_staging_vuln_source ON staging_vulnerability(data_source);
CREATE INDEX idx_staging_vuln_date ON staging_vulnerability(created_at DESC);

-- ============================================================================
-- 6. 유틸리티 Views
-- ============================================================================

-- 6.1 CVE 전체 정보 View (GR 좌표 포함)
CREATE VIEW v_cve_full_info AS
SELECT
    c.cve_id,
    c.description,
    c.cvss_v3_score,
    c.severity,
    c.cwe_id,
    cw.name AS cwe_name,
    cw.name_short AS cwe_short,
    nv.name AS named_vulnerability,
    cgm.layer_id,
    l.name AS layer_name,
    cgm.zone_id,
    z.name AS zone_name,
    cgm.tag_id,
    t.name AS tag_name,
    cgm.confidence AS gr_mapping_confidence
FROM cve c
LEFT JOIN cwe cw ON c.cwe_id = cw.id
LEFT JOIN cve_named_vulnerability cnv ON c.cve_id = cnv.cve_id
LEFT JOIN named_vulnerabilities nv ON cnv.named_vulnerability_id = nv.id
LEFT JOIN cve_gr_mapping cgm ON c.cve_id = cgm.cve_id
LEFT JOIN layers l ON cgm.layer_id = l.id
LEFT JOIN zones z ON cgm.zone_id = z.id
LEFT JOIN tags t ON cgm.tag_id = t.id;

-- 6.2 CWE-OWASP-CVE 연계 View
CREATE VIEW v_vulnerability_hierarchy AS
SELECT
    'CWE' AS vuln_type,
    cw.id AS vuln_id,
    cw.name_short AS short_name,
    cw.name AS full_name,
    cw.abstraction AS level,
    o.id AS owasp_id,
    o.name AS owasp_name,
    COUNT(DISTINCT c.cve_id) AS cve_count
FROM cwe cw
LEFT JOIN owasp_top10 o ON cw.id = ANY(o.mapped_cwes)
LEFT JOIN cve c ON c.cwe_id = cw.id
GROUP BY cw.id, cw.name_short, cw.name, cw.abstraction, o.id, o.name;

-- 6.3 GR 좌표별 취약점 통계 View
CREATE VIEW v_gr_vulnerability_stats AS
SELECT
    l.id AS layer_id,
    l.name AS layer_name,
    z.id AS zone_id,
    z.name AS zone_name,
    COUNT(DISTINCT cgm.cve_id) AS cve_count,
    COUNT(DISTINCT cwgm.cwe_id) AS cwe_count,
    COUNT(DISTINCT ogm.owasp_id) AS owasp_count,
    AVG(c.cvss_v3_score) AS avg_cvss_score,
    COUNT(DISTINCT CASE WHEN c.severity = 'Critical' THEN c.cve_id END) AS critical_count,
    COUNT(DISTINCT CASE WHEN c.severity = 'High' THEN c.cve_id END) AS high_count
FROM layers l
CROSS JOIN zones z
LEFT JOIN cve_gr_mapping cgm ON l.id = cgm.layer_id AND z.id = cgm.zone_id
LEFT JOIN cve c ON cgm.cve_id = c.cve_id
LEFT JOIN cwe_gr_mapping cwgm ON l.id = cwgm.layer_id AND z.id = cwgm.zone_id
LEFT JOIN owasp_gr_mapping ogm ON l.id = ogm.layer_id AND z.id = ogm.zone_id
GROUP BY l.id, l.name, z.id, z.name
ORDER BY l.position, z.trust_level;

-- 6.4 Named Vulnerability Dashboard View
CREATE VIEW v_named_vulnerability_dashboard AS
SELECT
    nv.name,
    nv.name_ko,
    nv.severity,
    nv.cvss_score,
    nv.primary_cve_id,
    array_length(nv.related_cves, 1) AS related_cve_count,
    nv.vulnerability_type,
    nv.exploitation_in_wild,
    nv.disclosure_date,
    cw.name_short AS cwe_short,
    STRING_AGG(DISTINCT l.name, ', ') AS affected_layers,
    STRING_AGG(DISTINCT z.name, ', ') AS affected_zones
FROM named_vulnerabilities nv
LEFT JOIN cwe cw ON nv.cwe_id = cw.id
LEFT JOIN named_vulnerability_gr_mapping nvgm ON nv.id = nvgm.named_vulnerability_id
LEFT JOIN layers l ON nvgm.layer_id = l.id
LEFT JOIN zones z ON nvgm.zone_id = z.id
GROUP BY nv.id, nv.name, nv.name_ko, nv.severity, nv.cvss_score,
         nv.primary_cve_id, nv.related_cves, nv.vulnerability_type,
         nv.exploitation_in_wild, nv.disclosure_date, cw.name_short
ORDER BY nv.cvss_score DESC NULLS LAST;

-- ============================================================================
-- 7. 초기 데이터 (Seed Data)
-- ============================================================================

-- 7.1 OWASP Top 10 2021 버전
INSERT INTO owasp_versions (id, name, release_date, is_current, url) VALUES
('2021', 'OWASP Top 10 2021', '2021-09-24', TRUE, 'https://owasp.org/Top10/'),
('2017', 'OWASP Top 10 2017', '2017-11-20', FALSE, 'https://owasp.org/www-project-top-ten/2017/'),
('2013', 'OWASP Top 10 2013', '2013-06-12', FALSE, NULL);

-- 7.2 OWASP Top 10 2021 항목
INSERT INTO owasp_top10 (id, owasp_version_id, rank, name, name_ko, mapped_cwes, owasp_url) VALUES
('A01:2021', '2021', 1, 'Broken Access Control', '취약한 접근 제어',
 ARRAY['CWE-22', 'CWE-23', 'CWE-35', 'CWE-59', 'CWE-200', 'CWE-201', 'CWE-219', 'CWE-264', 'CWE-275', 'CWE-276', 'CWE-284', 'CWE-285', 'CWE-352', 'CWE-359', 'CWE-377', 'CWE-402', 'CWE-425', 'CWE-441', 'CWE-497', 'CWE-538', 'CWE-540', 'CWE-548', 'CWE-552', 'CWE-566', 'CWE-601', 'CWE-639', 'CWE-651', 'CWE-668', 'CWE-706', 'CWE-862', 'CWE-863', 'CWE-913', 'CWE-922', 'CWE-1275'],
 'https://owasp.org/Top10/A01_2021-Broken_Access_Control/'),

('A02:2021', '2021', 2, 'Cryptographic Failures', '암호화 실패',
 ARRAY['CWE-261', 'CWE-296', 'CWE-310', 'CWE-319', 'CWE-321', 'CWE-322', 'CWE-323', 'CWE-324', 'CWE-325', 'CWE-326', 'CWE-327', 'CWE-328', 'CWE-329', 'CWE-330', 'CWE-331', 'CWE-335', 'CWE-336', 'CWE-337', 'CWE-338', 'CWE-340', 'CWE-347', 'CWE-523', 'CWE-720', 'CWE-757', 'CWE-759', 'CWE-760', 'CWE-780', 'CWE-818', 'CWE-916'],
 'https://owasp.org/Top10/A02_2021-Cryptographic_Failures/'),

('A03:2021', '2021', 3, 'Injection', '인젝션',
 ARRAY['CWE-20', 'CWE-74', 'CWE-75', 'CWE-77', 'CWE-78', 'CWE-79', 'CWE-80', 'CWE-83', 'CWE-87', 'CWE-88', 'CWE-89', 'CWE-90', 'CWE-91', 'CWE-93', 'CWE-94', 'CWE-95', 'CWE-96', 'CWE-97', 'CWE-98', 'CWE-99', 'CWE-100', 'CWE-113', 'CWE-116', 'CWE-138', 'CWE-184', 'CWE-470', 'CWE-471', 'CWE-564', 'CWE-610', 'CWE-643', 'CWE-644', 'CWE-652', 'CWE-917'],
 'https://owasp.org/Top10/A03_2021-Injection/'),

('A04:2021', '2021', 4, 'Insecure Design', '안전하지 않은 설계',
 ARRAY['CWE-73', 'CWE-183', 'CWE-209', 'CWE-213', 'CWE-235', 'CWE-256', 'CWE-257', 'CWE-266', 'CWE-269', 'CWE-280', 'CWE-311', 'CWE-312', 'CWE-313', 'CWE-316', 'CWE-419', 'CWE-430', 'CWE-434', 'CWE-444', 'CWE-451', 'CWE-472', 'CWE-501', 'CWE-522', 'CWE-525', 'CWE-539', 'CWE-579', 'CWE-598', 'CWE-602', 'CWE-642', 'CWE-646', 'CWE-650', 'CWE-653', 'CWE-656', 'CWE-657', 'CWE-799', 'CWE-807', 'CWE-840', 'CWE-841', 'CWE-927', 'CWE-1021', 'CWE-1173'],
 'https://owasp.org/Top10/A04_2021-Insecure_Design/'),

('A05:2021', '2021', 5, 'Security Misconfiguration', '보안 설정 오류',
 ARRAY['CWE-2', 'CWE-11', 'CWE-13', 'CWE-15', 'CWE-16', 'CWE-260', 'CWE-315', 'CWE-520', 'CWE-526', 'CWE-537', 'CWE-541', 'CWE-547', 'CWE-611', 'CWE-614', 'CWE-756', 'CWE-776', 'CWE-942', 'CWE-1004', 'CWE-1032', 'CWE-1174'],
 'https://owasp.org/Top10/A05_2021-Security_Misconfiguration/'),

('A06:2021', '2021', 6, 'Vulnerable and Outdated Components', '취약하고 오래된 컴포넌트',
 ARRAY['CWE-829', 'CWE-1035', 'CWE-1104'],
 'https://owasp.org/Top10/A06_2021-Vulnerable_and_Outdated_Components/'),

('A07:2021', '2021', 7, 'Identification and Authentication Failures', '식별 및 인증 실패',
 ARRAY['CWE-255', 'CWE-259', 'CWE-287', 'CWE-288', 'CWE-290', 'CWE-294', 'CWE-295', 'CWE-297', 'CWE-300', 'CWE-302', 'CWE-304', 'CWE-306', 'CWE-307', 'CWE-346', 'CWE-384', 'CWE-521', 'CWE-613', 'CWE-620', 'CWE-640', 'CWE-798', 'CWE-940', 'CWE-1216'],
 'https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/'),

('A08:2021', '2021', 8, 'Software and Data Integrity Failures', '소프트웨어 및 데이터 무결성 실패',
 ARRAY['CWE-345', 'CWE-353', 'CWE-426', 'CWE-494', 'CWE-502', 'CWE-565', 'CWE-784', 'CWE-829', 'CWE-830', 'CWE-915'],
 'https://owasp.org/Top10/A08_2021-Software_and_Data_Integrity_Failures/'),

('A09:2021', '2021', 9, 'Security Logging and Monitoring Failures', '보안 로깅 및 모니터링 실패',
 ARRAY['CWE-117', 'CWE-223', 'CWE-532', 'CWE-778'],
 'https://owasp.org/Top10/A09_2021-Security_Logging_and_Monitoring_Failures/'),

('A10:2021', '2021', 10, 'Server-Side Request Forgery (SSRF)', '서버 측 요청 위조',
 ARRAY['CWE-918'],
 'https://owasp.org/Top10/A10_2021-Server-Side_Request_Forgery_%28SSRF%29/');

-- 7.3 주요 CWE 카테고리
INSERT INTO cwe_categories (id, name, name_ko, category_type) VALUES
('CWE-1000', 'Research Concepts', '연구 개념', 'View'),
('CWE-699', 'Software Development', '소프트웨어 개발', 'View'),
('CWE-1003', 'Weaknesses for Simplified Mapping', '간소화된 매핑을 위한 약점', 'View'),
('CWE-1194', 'Hardware Design', '하드웨어 설계', 'View'),
('CWE-1008', 'Architectural Concepts', '아키텍처 개념', 'Category');

-- 7.4 주요 CWE (Top 25 + 주요 약점)
INSERT INTO cwe (id, name, name_ko, name_short, abstraction, likelihood_of_exploit, mitre_url) VALUES
('CWE-79', 'Improper Neutralization of Input During Web Page Generation', '웹 페이지 생성 시 입력값 부적절한 무력화', 'XSS', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/79.html'),
('CWE-89', 'Improper Neutralization of Special Elements used in an SQL Command', 'SQL 명령에 사용되는 특수 요소의 부적절한 무력화', 'SQL Injection', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/89.html'),
('CWE-78', 'Improper Neutralization of Special Elements used in an OS Command', 'OS 명령에 사용되는 특수 요소의 부적절한 무력화', 'OS Command Injection', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/78.html'),
('CWE-787', 'Out-of-bounds Write', '범위 밖 쓰기', 'Out-of-bounds Write', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/787.html'),
('CWE-20', 'Improper Input Validation', '부적절한 입력값 검증', 'Input Validation', 'Class', 'High', 'https://cwe.mitre.org/data/definitions/20.html'),
('CWE-125', 'Out-of-bounds Read', '범위 밖 읽기', 'Out-of-bounds Read', 'Base', 'Medium', 'https://cwe.mitre.org/data/definitions/125.html'),
('CWE-22', 'Improper Limitation of a Pathname to a Restricted Directory', '제한된 디렉토리에 대한 경로명의 부적절한 제한', 'Path Traversal', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/22.html'),
('CWE-352', 'Cross-Site Request Forgery', '크로스 사이트 요청 위조', 'CSRF', 'Compound', 'Medium', 'https://cwe.mitre.org/data/definitions/352.html'),
('CWE-434', 'Unrestricted Upload of File with Dangerous Type', '위험한 유형의 파일 무제한 업로드', 'File Upload', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/434.html'),
('CWE-502', 'Deserialization of Untrusted Data', '신뢰할 수 없는 데이터의 역직렬화', 'Deserialization', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/502.html'),
('CWE-918', 'Server-Side Request Forgery', '서버 측 요청 위조', 'SSRF', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/918.html'),
('CWE-287', 'Improper Authentication', '부적절한 인증', 'Authentication', 'Class', 'High', 'https://cwe.mitre.org/data/definitions/287.html'),
('CWE-306', 'Missing Authentication for Critical Function', '중요 기능에 대한 인증 누락', 'Missing Auth', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/306.html'),
('CWE-862', 'Missing Authorization', '권한 부여 누락', 'Missing Authorization', 'Class', 'High', 'https://cwe.mitre.org/data/definitions/862.html'),
('CWE-863', 'Incorrect Authorization', '잘못된 권한 부여', 'Incorrect Authorization', 'Class', 'High', 'https://cwe.mitre.org/data/definitions/863.html'),
('CWE-798', 'Use of Hard-coded Credentials', '하드코딩된 자격 증명 사용', 'Hardcoded Credentials', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/798.html'),
('CWE-77', 'Improper Neutralization of Special Elements used in a Command', '명령에 사용되는 특수 요소의 부적절한 무력화', 'Command Injection', 'Class', 'High', 'https://cwe.mitre.org/data/definitions/77.html'),
('CWE-94', 'Improper Control of Generation of Code', '코드 생성의 부적절한 제어', 'Code Injection', 'Base', 'High', 'https://cwe.mitre.org/data/definitions/94.html'),
('CWE-190', 'Integer Overflow or Wraparound', '정수 오버플로 또는 래핑', 'Integer Overflow', 'Base', 'Medium', 'https://cwe.mitre.org/data/definitions/190.html'),
('CWE-416', 'Use After Free', '해제 후 사용', 'Use After Free', 'Variant', 'High', 'https://cwe.mitre.org/data/definitions/416.html');

-- 7.5 주요 Named Vulnerabilities (유명 취약점)
INSERT INTO named_vulnerabilities (name, name_ko, primary_cve_id, related_cves, severity, cvss_score, vulnerability_type, attack_vector, cwe_id, disclosure_date, exploitation_in_wild, media_attention_score) VALUES
('Log4Shell', '로그4쉘', 'CVE-2021-44228', ARRAY['CVE-2021-45046', 'CVE-2021-45105', 'CVE-2021-44832'], 'Critical', 10.0, 'Remote Code Execution', 'Network', 'CWE-502', '2021-12-09', TRUE, 10),
('Heartbleed', '하트블리드', 'CVE-2014-0160', NULL, 'High', 7.5, 'Information Disclosure', 'Network', 'CWE-125', '2014-04-07', TRUE, 10),
('Shellshock', '쉘쇼크', 'CVE-2014-6271', ARRAY['CVE-2014-6277', 'CVE-2014-6278', 'CVE-2014-7169', 'CVE-2014-7186', 'CVE-2014-7187'], 'Critical', 9.8, 'Remote Code Execution', 'Network', 'CWE-78', '2014-09-24', TRUE, 9),
('Spectre', '스펙터', 'CVE-2017-5753', ARRAY['CVE-2017-5715'], 'Medium', 5.6, 'Information Disclosure', 'Local', 'CWE-200', '2018-01-03', FALSE, 9),
('Meltdown', '멜트다운', 'CVE-2017-5754', NULL, 'Medium', 5.6, 'Information Disclosure', 'Local', 'CWE-200', '2018-01-03', FALSE, 9),
('EternalBlue', '이터널블루', 'CVE-2017-0144', ARRAY['CVE-2017-0145', 'CVE-2017-0146', 'CVE-2017-0147', 'CVE-2017-0148'], 'Critical', 9.8, 'Remote Code Execution', 'Network', 'CWE-787', '2017-03-14', TRUE, 10),
('BlueKeep', '블루킵', 'CVE-2019-0708', NULL, 'Critical', 9.8, 'Remote Code Execution', 'Network', 'CWE-416', '2019-05-14', TRUE, 8),
('Spring4Shell', '스프링4쉘', 'CVE-2022-22965', NULL, 'Critical', 9.8, 'Remote Code Execution', 'Network', 'CWE-94', '2022-03-31', TRUE, 8),
('PrintNightmare', '프린트나이트메어', 'CVE-2021-34527', ARRAY['CVE-2021-1675'], 'Critical', 8.8, 'Remote Code Execution', 'Network', 'CWE-269', '2021-07-01', TRUE, 7),
('ProxyLogon', '프록시로그온', 'CVE-2021-26855', ARRAY['CVE-2021-26857', 'CVE-2021-26858', 'CVE-2021-27065'], 'Critical', 9.8, 'Remote Code Execution', 'Network', 'CWE-918', '2021-03-02', TRUE, 9),
('Dirty COW', '더티 카우', 'CVE-2016-5195', NULL, 'High', 7.8, 'Privilege Escalation', 'Local', 'CWE-362', '2016-10-19', TRUE, 7),
('POODLE', '푸들', 'CVE-2014-3566', NULL, 'Medium', 4.3, 'Information Disclosure', 'Network', 'CWE-310', '2014-10-14', TRUE, 6),
('DROWN', '드라운', 'CVE-2016-0800', NULL, 'High', 5.9, 'Information Disclosure', 'Network', 'CWE-310', '2016-03-01', FALSE, 6),
('KRACK', '크랙', 'CVE-2017-13077', ARRAY['CVE-2017-13078', 'CVE-2017-13079', 'CVE-2017-13080', 'CVE-2017-13081'], 'High', 6.8, 'Information Disclosure', 'Adjacent', 'CWE-323', '2017-10-16', FALSE, 7),
('Zerologon', '제로로그온', 'CVE-2020-1472', NULL, 'Critical', 10.0, 'Privilege Escalation', 'Network', 'CWE-330', '2020-08-11', TRUE, 8);

-- ============================================================================
-- End of Vulnerability Extension Schema
-- ============================================================================
